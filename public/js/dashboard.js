!function(e){e(".command-list table").sortable({containerSelector:"table",itemPath:"> tbody",itemSelector:"tr",placeholder:'<tr class="placeholder"/>',delay:500,onDrop:function(t,i,n){n(t,i);var a=[];e("tbody tr td:first-child",i.el[0]).each(function(t,i){a.push(e(i).data("command-id"))}),e.ajax({url:"/commands/reorder",method:"POST",data:{commands:a}})}});var t;e("#command").on("hidden.bs.modal",function(e){t.destroy()}),e("#command").on("show.bs.modal",function(i){var n=e(i.relatedTarget),a=e(this),s=trans("commands.create");t=ace.edit("command_script"),t.getSession().setMode("ace/mode/sh"),e(".btn-danger",a).hide(),e(".callout-danger",a).hide(),e(".has-error",a).removeClass("has-error"),e(".label-danger",a).remove(),n.hasClass("btn-edit")?(s=trans("commands.edit"),e(".btn-danger",a).show()):(e("#command_id").val(""),e("#command_step").val(n.data("step")),e("#command_name").val(""),t.setValue(""),t.gotoLine(1),e("#command_user").val(""),e("#command_optional").prop("checked",!1),e("#command_default_on").prop("checked",!1),e("#command_default_on_row").addClass("hide"),e(".command-environment").prop("checked",!0),e(".command-pattern").prop("checked",!0)),a.find(".modal-title span").text(s)}),e("body").delegate(".command-trash button.btn-delete","click",function(t){var i=e(t.currentTarget),n=i.find("i"),a=i.parents(".modal");n.removeClass().addClass("piplin piplin-load piplin-spin"),a.find("input").attr("disabled","disabled"),e("button.close",a).hide(),Piplin.Commands.get(e("#model_id").val()).destroy({wait:!0,success:function(t,i,s){a.modal("hide"),e(".callout-danger",a).hide(),n.removeClass().addClass("piplin piplin-delete"),e("button.close",a).show(),a.find("input").removeAttr("disabled"),Piplin.toast(trans("commands.delete_success"))},error:function(){n.removeClass().addClass("piplin piplin-delete"),e("button.close",a).show(),a.find("input").removeAttr("disabled")}})}),e("#command_optional").on("change",function(t){e("#command_default_on_row").addClass("hide"),!0===e(this).is(":checked")&&e("#command_default_on_row").removeClass("hide")}),e("#command button.btn-save").off("click").on("click",function(i){var n=e(i.currentTarget),a=n.find("i"),s=n.parents(".modal");a.removeClass().addClass("piplin piplin-load piplin-spin"),s.find(":input").attr("disabled","disabled"),e("button.close",s).hide();var l=e("#command_id").val();if(l)var o=Piplin.Commands.get(l);else var o=new Piplin.Command;var r=[];e(".command-environment:checked").each(function(){r.push(e(this).val())});var d=[];e(".command-pattern:checked").each(function(){d.push(e(this).val())}),o.save({name:e("#command_name").val(),script:t.getValue(),user:e("#command_user").val(),step:e("#command_step").val(),targetable_type:e('input[name="targetable_type"]').val(),targetable_id:e('input[name="targetable_id"]').val(),environments:r,patterns:d,optional:e("#command_optional").is(":checked"),default_on:e("#command_default_on").is(":checked")},{wait:!0,success:function(i,n,o){s.modal("hide"),e(".callout-danger",s).hide(),a.removeClass().addClass("piplin piplin-save"),e("button.close",s).show(),s.find(":input").removeAttr("disabled");var r=trans("commands.edit_success");l||(Piplin.Commands.add(n),r=trans("commands.create_success")),t.setValue(""),t.gotoLine(1),Piplin.toast(r)},error:function(t,i,n){e(".callout-danger",s).show();var l=i.responseJSON;e(".has-error",s).removeClass("has-error"),e(".label-danger",s).remove(),e("form input",s).each(function(t,i){i=e(i);var n=i.attr("name");if(void 0!==l[n]){var a=i.parent("div");a.addClass("has-error"),a.append(e("<span>").attr("class","label label-danger").text(l[n]))}}),a.removeClass().addClass("piplin piplin-save"),e("button.close",s).show(),s.find(":input").removeAttr("disabled")}})}),Piplin.Command=Backbone.Model.extend({urlRoot:"/commands",defaults:function(){return{order:Piplin.Commands.nextOrder()}},isAfter:function(){return parseInt(this.get("step"))%3==0}});var i=Backbone.Collection.extend({model:Piplin.Command,comparator:"order",nextOrder:function(){return this.length?this.last().get("order")+1:1}});Piplin.Commands=new i,Piplin.CommandsTab=Backbone.View.extend({el:"#app",events:{},initialize:function(){this.$beforeList=e("#commands-before .command-list tbody"),this.$afterList=e("#commands-after .command-list tbody"),e(".no-commands").show(),e(".command-list").hide(),this.listenTo(Piplin.Commands,"add",this.addOne),this.listenTo(Piplin.Commands,"reset",this.addAll),this.listenTo(Piplin.Commands,"remove",this.addAll),this.listenTo(Piplin.Commands,"all",this.render),Piplin.listener.on("command:"+Piplin.events.MODEL_CHANGED,function(e){var t=Piplin.Commands.get(parseInt(e.model.id));t&&t.set(e.model)}),Piplin.listener.on("command:"+Piplin.events.MODEL_CREATED,function(t){var i=e('input[name="targetable_type"]').val(),n=e('input[name="targetable_id"]').val();i==t.model.targetable_type&&parseInt(t.model.targetable_id)===parseInt(n)&&(parseInt(t.model.step)+1!==parseInt(Piplin.command_action)&&parseInt(t.model.step)-1!==parseInt(Piplin.command_action)||Piplin.Commands.add(t.model))}),Piplin.listener.on("command:"+Piplin.events.MODEL_TRASHED,function(e){var t=Piplin.Commands.get(parseInt(e.model.id));t&&Piplin.Commands.remove(t)})},render:function(){void 0!==Piplin.Commands.find(function(e){return!e.isAfter()})?(e("#commands-before .no-commands").hide(),e("#commands-before .command-list").show()):(e("#commands-before .no-commands").show(),e("#commands-before .command-list").hide()),void 0!==Piplin.Commands.find(function(e){return e.isAfter()})?(e("#commands-after .no-commands").hide(),e("#commands-after .command-list").show()):(e("#commands-after .no-commands").show(),e("#commands-after .command-list").hide())},addOne:function(t){var i=new Piplin.CommandView({model:t});t.isAfter()?(this.$afterList.append(i.render().el),e("tr",this.$afterList).length<2?e(".drag-handle",this.$afterList).hide():e(".drag-handle",this.$afterList).show()):(this.$beforeList.append(i.render().el),e("tr",this.$beforeList).length<2?e(".drag-handle",this.$beforeList).hide():e(".drag-handle",this.$beforeList).show())},addAll:function(){this.$beforeList.html(""),this.$afterList.html(""),Piplin.Commands.each(this.addOne,this)}}),Piplin.CommandView=Backbone.View.extend({tagName:"tr",events:{"click .btn-edit":"edit","click .btn-delete":"trash"},initialize:function(){this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"destroy",this.remove),this.template=_.template(e("#command-template").html())},render:function(){var e=this.model.toJSON();return this.$el.html(this.template(e)),this},edit:function(){e("#command_id").val(this.model.id),e("#command_step").val(this.model.get("step")),e("#command_name").val(this.model.get("name")),e("#command_script").text(this.model.get("script")),e("#command_user").val(this.model.get("user")),e("#command_optional").prop("checked",!0===this.model.get("optional")),e("#command_default_on").prop("checked",!0===this.model.get("default_on")),e("#command_default_on_row").addClass("hide"),!0===this.model.get("optional")&&e("#command_default_on_row").removeClass("hide"),e(".command-environment").prop("checked",!1),e(this.model.get("environments")).each(function(t,i){e("#command_environment_"+i.id).prop("checked",!0)}),e(".command-pattern").prop("checked",!1),e(this.model.get("patterns")).each(function(t,i){e("#command_pattern_"+i.id).prop("checked",!0)})},trash:function(){var t=e("#model_id");t.val(this.model.id),t.parents(".modal").removeClass().addClass("modal fade command-trash")}})}(jQuery),function(e){function t(t,a){n||(n=!0,e.ajax({type:"GET",url:"/log/"+a}).done(function(e){var n=i(e.output?e.output:""),a=!1;t.scrollTop()+t.innerHeight()>=t.get(0).scrollHeight&&(a=!0),t.html(n),a&&t.scrollTop(t.get(0).scrollHeight)}).always(function(){n=!1}))}function i(e){return e.replace(/<\/error>/g,"</span>").replace(/<\/info>/g,"</span>").replace(/<error>/g,'<span class="text-red">').replace(/<info>/g,'<span class="text-default">')}e("#task").on("show.bs.modal",function(t){var i=e(this);e(".callout-danger",i).hide();var n=e('input[name="targetable_type"]').val();if(new RegExp("BuildPlan$").test(n)){var a=trans("tasks.build");i.find(".modal-title span").text(a),i.find(".modal-title i").removeClass().addClass("piplin piplin-build"),i.find("button.btn-save span").text(a)}else e("#task_source_release").is(":checked")&&e("#task_release").parent("div").show()}),e(".task-source:radio").on("change",function(t){var i=e(t.currentTarget);e("div.task-source-container").hide(),"branch"===i.val()?e("#task_branch").parent("div").show():"tag"===i.val()?e("#task_tag").parent("div").show():"commit"===i.val()?e("#task_commit").parent("div").show():"release"===i.val()&&e("#task_release").parent("div").show()}),e("#task button.btn-save").on("click",function(t){var i=e(t.currentTarget),n=i.find("i"),a=i.parents(".modal");n.removeClass().addClass("piplin piplin-load piplin-spin"),a.find("input").attr("disabled","disabled"),e("button.close",a).hide();var s=new Piplin.Deploy,l=[];e(".task-environment:checked").each(function(){l.push(e(this).val())});var o=[];e(".task-command:checked").each(function(){o.push(e(this).val())}),s.save({environments:l,project_id:e('input[name="project_id"]').val(),targetable_type:e('input[name="targetable_type"]').val(),targetable_id:e('input[name="targetable_id"]').val(),reason:e("#task_reason").val(),source:e('input[name="source"]:checked').val(),source_branch:e("#task_branch").val(),source_tag:e("#task_tag").val(),source_commit:e("#task_commit").val(),source_release:e("#task_release").val(),optional:o},{wait:!0,success:function(t,i,s){a.modal("hide"),e(".callout-danger",a).hide(),n.removeClass().addClass("piplin piplin-save"),e("button.close",a).show(),a.find("input").removeAttr("disabled");var l=trans("tasks.submit_success");Piplin.toast(l)},error:function(t,i,s){e(".callout-danger",a).show();var l=i.responseJSON;if(e(".has-error",a).removeClass("has-error"),e(".label-danger",a).remove(),void 0!==l.environments){e(".task-environment").parents("div.form-group").addClass("has-error")}n.removeClass().addClass("piplin piplin-save"),e("button.close",a).show(),a.find("input").removeAttr("disabled")}})}),e("#rollback").on("show.bs.modal",function(t){var i=e(t.relatedTarget),n=i.data("task-id"),a=e(this);e('input[name="task_id"]',a).val(n),e("#task_reason",a).val(""),e(".task-command",a).prop("checked",!1)}),e("#rollback button.btn-save").on("click",function(t){var i=e(t.currentTarget),n=i.find("i"),a=i.parents(".modal");n.removeClass().addClass("piplin piplin-load piplin-spin"),a.find("input").attr("disabled","disabled"),e("button.close",a).hide();var s=e("#task_reason",a).val(),l=[];e(".task-command:checked",a).each(function(){l.push(e(this).val())}),e.ajax({url:"/task/"+e('input[name="task_id"]',a).val()+"/rollback",method:"POST",data:{reason:s,optional:l}}).fail(function(t){e(".callout-danger",a).show();t.responseJSON;e(".has-error",a).removeClass("has-error"),e(".label-danger",a).remove(),n.removeClass().addClass("piplin piplin-save"),e("button.close",a).show(),a.find("input").removeAttr("disabled")}).done(function(t){a.modal("hide"),e(".callout-danger",a).hide(),n.removeClass().addClass("piplin piplin-save"),e("button.close",a).show(),a.find("input").removeAttr("disabled"),Piplin.toast(trans("tasks.submit_success"))})}),e("#task_draft").on("show.bs.modal",function(t){var i=e(t.relatedTarget),n=i.data("task-id"),a=e(this);e('input[name="task_id"]',a).val(n)}),e("#task_draft button.btn-save").on("click",function(t){var i=e(t.currentTarget),n=i.find("i"),a=i.parents(".modal");n.removeClass().addClass("piplin piplin-load piplin-spin"),a.find("input").attr("disabled","disabled"),e("button.close",a).hide(),e.ajax({url:"/task/"+e('input[name="task_id"]',a).val()+"/task-draft",method:"POST"}).done(function(t){a.modal("hide"),e(".callout-danger",a).hide(),n.removeClass().addClass("piplin piplin-save"),e("button.close",a).show(),a.find("input").removeAttr("disabled"),Piplin.toast(trans("tasks.submit_success"))})}),e(".btn-cancel").on("click",function(t){var i=e(t.currentTarget),n=i.data("task-id");e("form#abort_"+n).trigger("submit")});var n=!1;e("#log").on("show.bs.modal",function(a){var s=e(a.relatedTarget),l=s.attr("id").replace("log_",""),o=e("h3 span",s.parents(".box")).text(),r=e(this),d=e("pre",r),p=e("#loading",r);d.hide(),p.show(),e("#action",r).text(o),d.text(""),n=!0,e.ajax({type:"GET",url:"/log/"+l}).done(function(e){var n=i(e.output?e.output:"");d.html(n),d.show(),p.hide(),Piplin.listener.on("serverlog-"+l+":"+Piplin.events.OUTPUT_CHANGED,function(e){e.log_id===parseInt(l)&&t(d,e.log_id)})}).always(function(){n=!1})}),e("#log").on("hide.bs.modal",function(){n=!1}),Piplin.Deploy=Backbone.Model.extend({urlRoot:"/tasks"}),Piplin.ServerLog=Backbone.Model.extend({urlRoot:"/status"});var a=Backbone.Collection.extend({model:Piplin.ServerLog});Piplin.Task=new a,Piplin.TaskView=Backbone.View.extend({el:"#app",$containers:[],events:{},initialize:function(){var t=this;e(".task-step tbody").each(function(i,n){t.$containers.push({step:parseInt(e(n).attr("id").replace("step_","")),element:n})}),this.listenTo(Piplin.Task,"add",this.addOne),this.listenTo(Piplin.Task,"reset",this.addAll),this.listenTo(Piplin.Task,"remove",this.addAll),this.listenTo(Piplin.Task,"all",this.render),Piplin.listener.on("serverlog:"+Piplin.events.SVRLOG_CHANGED,function(e){var t=Piplin.Task.get(e.log_id);t&&t.set({status:e.status,output:e.output,runtime:e.runtime,started_at:!!e.started_at&&e.started_at,finished_at:!!e.finished_at&&e.finished_at})}),Piplin.listener.on("task:"+Piplin.events.MODEL_CHANGED,function(t){if(parseInt(t.model.project_id)===parseInt(Piplin.project_id)){var i=e("#task_status_bar"),n=Piplin.formatTaskStatus(parseInt(t.model.status));i.attr("class","text-"+n.label_class),e("i",i).attr("class","piplin piplin-"+n.icon_class),e("span",i).text(n.label),t.model.run_failure?(e("#task_status").find("p").text(t.model.output),e("#task_status").removeClass("hide").show()):e("#task_status").hide()}})},addOne:function(t){var i=new Piplin.LogView({model:t}),n=_.find(this.$containers,function(e){return parseInt(e.step)===parseInt(t.get("task_step_id"))});e(n.element).append(i.render().el)},addAll:function(){e(this.$containers).each(function(e,t){t.html("")}),Piplin.Commands.each(this.addOne,this)}}),Piplin.LogView=Backbone.View.extend({tagName:"tr",events:{},initialize:function(){this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"destroy",this.remove),this.template=_.template(e("#log-template").html())},render:function(){var e=this.model.toJSON(),t=parseInt(this.model.get("status"));return e.label_class="info",e.icon_css="clock",e.label=trans("tasks.pending"),t===Piplin.statuses.SVRLOG_COMPLETED?(e.label_class="success",e.icon_css="check",e.label=trans("tasks.completed")):t===Piplin.statuses.SVRLOG_RUNNING?(e.label_class="warning",e.icon_css="load piplin-spin",e.label=trans("tasks.running")):t===Piplin.statuses.SVRLOG_FAILED?(e.label_class="danger",e.icon_css="close",e.label=trans("tasks.failed")):t===Piplin.statuses.SVRLOG_CANCELLED&&(e.label_class="danger",e.icon_css="close",e.label=trans("tasks.cancelled")),e.formatted_start_time=!!e.started_at&&moment(e.started_at).format("HH:mm:ss"),e.formatted_end_time=!!e.finished_at&&moment(e.finished_at).format("HH:mm:ss"),this.$el.removeClass().addClass("bg-"+e.label_class).html(this.template(e)),this}})}(jQuery),function(e){function t(t,i){e("#hook .modal-title span").text(trans("hooks."+i+"_"+t));var n=e("#hook .modal-title i").removeClass().addClass("ion"),a="edit";"slack"===t?a="slack":"dingtalk"===t?a="pin":"mail"===t?a="email":"custom"===t&&(a="edit"),n.addClass("piplin-"+a),e("#hook .modal-footer").show(),e(".hook-config").hide(),e("#hook-type").hide(),e("#hook-name").show(),e("#hook-triggers").show(),e(".hook-enabled").show(),e("#hook-config-"+t).show(),e("#hook_type").val(t)}e("#hook").on("show.bs.modal",function(t){var i=e(t.relatedTarget),n=e(this);e(".btn-danger",n).hide(),e(".callout-danger",n).hide(),e(".callout-warning",n).hide(),e(".has-error",n).removeClass("has-error"),e(".label-danger",n).remove(),i.hasClass("btn-edit")?e(".btn-danger",n).show():(e("#hook_id").val(""),e("#hook_name").val(""),e("#hook_type").val(""),e("#hook :input[id^=hook_config]").val(""),e("#hook .hook-config input[type=checkbox]").prop("checked",!0),e("#hook .hook-enabled input[type=checkbox]").prop("checked",!0),e("#hook .modal-footer").hide(),e(".hook-config").hide(),e(".hook-enabled").hide(),e("#hook-type").show(),n.find(".modal-title span").text(trans("hooks.create")))}),e("#hook #hook-type a.btn-app").on("click",function(i){var n=e(i.currentTarget),a=e("#hook");if(n.attr("disabled"))return void e(".callout-warning",a).show();e(".callout-warning",a).hide(),t(n.data("type"),"create")}),e("body").delegate(".hook-trash button.btn-delete","click",function(t){var i=e(t.currentTarget),n=i.find("i"),a=i.parents(".modal");n.removeClass().addClass("piplin piplin-load piplin-spin"),a.find("input").attr("disabled","disabled"),e("button.close",a).hide(),Piplin.Hooks.get(e("#model_id").val()).destroy({wait:!0,success:function(t,i,s){a.modal("hide"),e(".callout-danger",a).hide(),n.removeClass().addClass("piplin piplin-delete"),e("button.close",a).show(),a.find("input").removeAttr("disabled"),Piplin.toast(trans("hooks.delete_success"))},error:function(){n.removeClass().addClass("piplin piplin-delete"),e("button.close",a).show(),a.find("input").removeAttr("disabled")}})}),e("#hook button.btn-save").on("click",function(t){var i=e(t.currentTarget),n=i.find("i"),a=i.parents(".modal");n.removeClass().addClass("piplin piplin-load piplin-spin"),a.find("input").attr("disabled","disabled"),e("button.close",a).hide();var s=e("#hook_id").val();if(s)var l=Piplin.Hooks.get(s);else var l=new Piplin.Hook;var o={config:null,name:e("#hook_name").val(),type:e("#hook_type").val(),project_id:parseInt(e('input[name="project_id"]').val()),enabled:e("#hook_enabled").is(":checked"),on_task_success:e("#hook_on_task_success").is(":checked"),on_task_failure:e("#hook_on_task_failure").is(":checked")};e("#hook #hook-config-"+o.type+" :input[id^=hook_config]").each(function(t,i){var n=e(i).attr("name");o[n]=e(i).val()}),l.save(o,{wait:!0,success:function(t,i,l){a.modal("hide"),e(".callout-danger",a).hide(),n.removeClass().addClass("piplin piplin-save"),e("button.close",a).show(),a.find("input").removeAttr("disabled");var o=trans("hooks.edit_success");s||(Piplin.Hooks.add(i),o=trans("hooks.create_success")),Piplin.toast(o)},error:function(t,i,s){e(".callout-danger",a).show();var l=i.responseJSON;e(".has-error",a).removeClass("has-error"),e(".label-danger",a).remove(),e("form input",a).each(function(t,i){i=e(i);var n=i.attr("name");if(void 0!==l[n]){var a=i.parent();a.addClass("has-error"),a.append(e("<span>").attr("class","label label-danger").text(l[n]))}}),n.removeClass().addClass("piplin piplin-save"),e("button.close",a).show(),a.find("input").removeAttr("disabled")}})}),Piplin.Hook=Backbone.Model.extend({urlRoot:"/hooks/"+parseInt(e('input[name="project_id"]').val())});var i=Backbone.Collection.extend({model:Piplin.Hook});Piplin.Hooks=new i,Piplin.HooksTab=Backbone.View.extend({el:"#app",events:{},initialize:function(){this.$list=e("#hook_list tbody"),e("#no_hooks").show(),e("#hook_list").hide(),this.listenTo(Piplin.Hooks,"add",this.addOne),this.listenTo(Piplin.Hooks,"reset",this.addAll),this.listenTo(Piplin.Hooks,"remove",this.addAll),this.listenTo(Piplin.Hooks,"all",this.render),Piplin.listener.on("hook:"+Piplin.events.MODEL_CHANGED,function(e){var t=Piplin.Hooks.get(parseInt(e.model.id));t&&t.set(e.model)}),Piplin.listener.on("hook:"+Piplin.events.MODEL_CREATED,function(e){parseInt(e.model.project_id)===parseInt(Piplin.project_id)&&Piplin.Hooks.add(e.model)}),Piplin.listener.on("hook:"+Piplin.events.MODEL_TRASHED,function(e){var t=Piplin.Hooks.get(parseInt(e.model.id));t&&Piplin.Hooks.remove(t)})},render:function(){Piplin.Hooks.length?(e("#no_hooks").hide(),e("#hook_list").show()):(e("#no_hooks").show(),e("#hook_list").hide())},addOne:function(e){var t=new Piplin.HookView({model:e});this.$list.append(t.render().el)},addAll:function(){this.$list.html(""),Piplin.Hooks.each(this.addOne,this)}}),Piplin.HookView=Backbone.View.extend({tagName:"tr",events:{"click .btn-edit":"edit","click .btn-delete":"trash"},initialize:function(){this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"destroy",this.remove),this.template=_.template(e("#hook-template").html())},render:function(){var e=this.model.toJSON();return e.icon="edit",e.label=trans("hooks.custom"),"custom"!==this.model.get("type")&&(e.label=trans("hooks."+this.model.get("type"))),"slack"===this.model.get("type")?e.icon="slack":"dingtalk"===this.model.get("type")?e.icon="pin":"mail"===this.model.get("type")&&(e.icon="email"),this.$el.html(this.template(e)),this},edit:function(){var i=this.model.get("type");e.each(this.model.get("config"),function(t,n){e("#hook-config-"+i+" #hook_config_"+t).val(n)}),e("#hook_id").val(this.model.id),e("#hook_name").val(this.model.get("name")),e("#hook_type").val(i),e("#hook_enabled").prop("checked",!0===this.model.get("enabled")),e("#hook_on_task_success").prop("checked",!0===this.model.get("on_task_success")),e("#hook_on_task_failure").prop("checked",!0===this.model.get("on_task_failure")),t(this.model.get("type"),"edit")},trash:function(){var t=e("#model_id");t.val(this.model.id),t.parents(".modal").removeClass().addClass("modal fade hook-trash")}})}(jQuery),function(e){var t={placeholder:trans("members.search"),minimumInputLength:1,width:"100%",ajax:{url:"/api/autocomplete/users",dataType:"json",delay:250,data:function(e){return{q:e.term}},processResults:function(t){return{results:e.map(t,function(e){return{id:e.id,text:e.name+"("+e.nickname+")"}})}},cache:!0}},i=e(".project-members").select2(t);e("#member").on("show.bs.modal",function(t){var n=e(t.relatedTarget),a=e(this),s=trans("members.create");e(".btn-danger",a).hide(),e(".callout-danger",a).hide(),e(".callout-warning",a).hide(),e(".has-error",a).removeClass("has-error"),e(".label-danger",a).remove(),n.hasClass("btn-edit")?(s=trans("members.edit"),e("#user_ids").parent().parent().hide(),e(".btn-danger",a).show()):(e("#user_ids").parent().parent().show(),i.val("").trigger("change"),a.find(".modal-title span").text(trans("members.create"))),a.find(".modal-title span").text(s)}),e("#member #member-type a.btn-app").on("click",function(t){var i=e(t.currentTarget),n=e("#member");if(i.attr("disabled"))return void e(".callout-warning",n).show();e(".callout-warning",n).hide()}),e("body").delegate(".member-trash button.btn-delete","click",function(t){var i=e(t.currentTarget),n=i.find("i"),a=i.parents(".modal");n.removeClass().addClass("piplin piplin-load piplin-spin"),a.find("input").attr("disabled","disabled"),e("button.close",a).hide(),Piplin.Members.get(e("#model_id").val()).destroy({wait:!0,success:function(t,i,s){a.modal("hide"),e(".callout-danger",a).hide(),n.removeClass().addClass("piplin piplin-save"),e("button.close",a).show(),a.find("input").removeAttr("disabled"),Piplin.toast(trans("members.delete_success"))},error:function(){n.removeClass().addClass("piplin piplin-save"),e("button.close",a).show(),a.find("input").removeAttr("disabled")}})}),e("#member button.btn-save").on("click",function(t){var i=e(t.currentTarget),n=i.find("i"),a=i.parents(".modal");n.removeClass().addClass("piplin piplin-load piplin-spin"),a.find("input").attr("disabled","disabled"),e("button.close",a).hide();var s=e("#member_id").val();if(s)var l=Piplin.Members.get(s);else var l=new Piplin.Member;var o={user_ids:e("#user_ids").val(),project_id:parseInt(e('input[name="project_id"]').val())};l.save(o,{wait:!0,success:function(t,i,l){a.modal("hide"),e(".callout-danger",a).hide(),n.removeClass().addClass("piplin piplin-save"),e("button.close",a).show(),a.find("input").removeAttr("disabled");var o=trans("members.edit_success");s||(Piplin.Members.add(i),o=trans("members.create_success")),Piplin.toast(o)},error:function(t,i,s){e(".callout-danger",a).show();var l=i.responseJSON;e(".has-error",a).removeClass("has-error"),e(".label-danger",a).remove(),e("form select",a).each(function(t,i){i=e(i);var n=i.attr("name");if(void 0!==l[n]){var a=i.parent();a.addClass("has-error"),a.append(e("<span>").attr("class","label label-danger").text(l[n]))}}),n.removeClass().addClass("piplin piplin-save"),e("button.close",a).show(),a.find("input").removeAttr("disabled")}})}),Piplin.Member=Backbone.Model.extend({urlRoot:"/members/"+parseInt(e('input[name="project_id"]').val())});var n=Backbone.Collection.extend({model:Piplin.Member});Piplin.Members=new n,Piplin.MembersTab=Backbone.View.extend({el:"#app",events:{},initialize:function(){this.$list=e("#member_list tbody"),e("#no_members").show(),e("#member_list").hide(),this.listenTo(Piplin.Members,"add",this.addOne),this.listenTo(Piplin.Members,"reset",this.addAll),this.listenTo(Piplin.Members,"remove",this.addAll),this.listenTo(Piplin.Members,"all",this.render),Piplin.listener.on("member:"+Piplin.events.MODEL_CHANGED,function(e){var t=Piplin.Members.get(parseInt(e.model.id));t&&t.set(e.model)}),Piplin.listener.on("member:"+Piplin.events.MODEL_CREATED,function(e){parseInt(e.model.project_id)===parseInt(Piplin.project_id)&&Piplin.Members.add(e.model)}),Piplin.listener.on("member:"+Piplin.events.MODEL_TRASHED,function(e){var t=Piplin.Members.get(parseInt(e.model.id));t&&Piplin.Members.remove(t)})},render:function(){Piplin.Members.length?(e("#no_members").hide(),e("#member_list").show()):(e("#no_members").show(),e("#member_list").hide())},addOne:function(e){var t=new Piplin.MemberView({model:e});this.$list.append(t.render().el)},addAll:function(){this.$list.html(""),Piplin.Members.each(this.addOne,this)}}),Piplin.MemberView=Backbone.View.extend({tagName:"tr",events:{"click .btn-delete":"trash"},initialize:function(){this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"destroy",this.remove),this.template=_.template(e("#member-template").html())},render:function(){var e=this.model.toJSON();return this.$el.html(this.template(e)),this},trash:function(){var t=e("#model_id");t.val(this.model.id),t.parents(".modal").removeClass().addClass("modal fade member-trash")}})}(jQuery),function(e){e("#project_create").on("show.bs.modal",function(t){var i=e(t.relatedTarget),n=e(this),a=trans("projects.create"),s=i.data("project-id");i.hasClass("btn-edit")&&(a=trans("projects.edit"),e.ajax({type:"POST",url:"/api/projects",data:{project_id:s}}).done(function(t){Piplin.Projects.reset(t),e("#project_id").val(t.id),e("#project_name").val(t.name),e("#project_description").val(t.description),e("#project_repository").val(t.repository),e("#project_branch").val(t.branch),e("#project_deploy_path").val(t.deploy_path),e("#project_allow_other_branch").prop("checked",!0===t.allow_other_branch)})),n.find(".modal-title span").text(a),e(".callout-danger",n).hide()}),e("#project_create button.btn-save").on("click",function(t){var i=e(t.currentTarget),n=i.find("i"),a=i.parents(".modal");n.removeClass().addClass("piplin piplin-load piplin-spin"),a.find("input").attr("disabled","disabled"),e("button.close",a).hide();var s=e("#project_id").val();if(s)var l=Piplin.Projects.get(s);else var l=new Piplin.Project;l.save({name:e("#project_name").val(),description:e("#project_description").val(),repository:e("#project_repository").val(),branch:e("#project_branch").val(),deploy_path:e("#project_deploy_path").val(),allow_other_branch:e("#project_allow_other_branch").is(":checked")},{wait:!0,success:function(t,i,l){a.modal("hide"),e(".callout-danger",a).hide(),n.removeClass().addClass("piplin piplin-save"),e("button.close",a).show(),a.find("input").removeAttr("disabled"),Piplin.Projects.reset(i);var o=trans("projects.edit_success");s||(o=trans("projects.create_success")),Piplin.toast(o,"","success"),window.location.href="/project/"+i.id},error:function(t,i,s){e(".callout-danger",a).show();var l=i.responseJSON;e(".has-error",a).removeClass("has-error"),e(".label-danger",a).remove(),e("form :input",a).each(function(t,i){i=e(i);var n=i.attr("name");if(void 0!==l[n]){var a=i.parent("div");a.addClass("has-error"),a.append(e("<span>").attr("class","label label-danger").text(l[n]))}}),n.removeClass().addClass("piplin piplin-save"),e("button.close",a).show(),a.find("input").removeAttr("disabled")}})}),e("#model-trash").on("show.bs.modal",function(t){var i=e(t.relatedTarget),n=(e(this),trans("projects.delete"),i.data("project-id"));if(i.hasClass("project-delete")){var a=e("#model_id");a.val(n),a.parents(".modal").removeClass().addClass("modal fade project-trash"),e.ajax({type:"POST",url:"/api/projects",data:{project_id:n}}).done(function(e){Piplin.Projects.reset(e)})}}),e("body").delegate(".project-trash button.btn-delete","click",function(t){var i=e(t.currentTarget),n=i.find("i"),a=i.parents(".modal");n.removeClass().addClass("piplin piplin-load piplin-spin"),a.find("input").attr("disabled","disabled"),e("button.close",a).hide(),Piplin.Projects.get(e("#model_id").val()).destroy({wait:!0,success:function(t,i,s){a.modal("hide"),e(".callout-danger",a).hide(),n.removeClass().addClass("piplin piplin-delete"),e("button.close",a).show(),a.find("input").removeAttr("disabled"),Piplin.toast(trans("projects.delete_success")),window.location.href="/"},error:function(){n.removeClass().addClass("piplin piplin-delete"),e("button.close",a).show(),a.find("input").removeAttr("disabled")}})}),e("#project-recover button.btn-recover").on("click",function(t){var i=e(t.currentTarget),n=i.find("i"),a=i.parents(".modal");n.removeClass().addClass("piplin piplin-load piplin-spin"),a.find("input").attr("disabled","disabled"),e("button.close",a).hide(),e.ajax({url:"/project/"+e('input[name="project_id"]',a).val()+"/recover",method:"POST"}).done(function(t){a.modal("hide"),e(".callout-danger",a).hide(),Piplin.toast(trans("projects.recover_success"));var i=Piplin.formatProjectStatus(t.status),s=e("td.project-status span");s.attr("class","text-"+i.label_class),e("i",s).attr("class","piplin piplin-"+i.icon_class),e("span",s).text(i.label),n.removeClass().addClass("piplin piplin-save"),e("button.close",a).show()})}),Piplin.Project=Backbone.Model.extend({urlRoot:"/projects"});var t=Backbone.Collection.extend({model:Piplin.Project});Piplin.Projects=new t,e("#new_webhook").on("click",function(t){var i=e(t.currentTarget),n=i.data("project-id"),a=i.data("type"),s=e("i",i),l="/webhook/"+n+"/refresh";"build"==a&&(l+="/build"),e(".piplin-spin",i).length>0||(i.attr("disabled","disabled"),s.addClass("piplin-spin"),e("#webhook").fadeOut(3e3),e.ajax({type:"GET",url:l}).fail(function(e){}).done(function(t){e("#webhook").fadeIn(3e3).val(t.url)}).always(function(){s.removeClass("piplin-spin"),i.removeAttr("disabled")}))}),e("#webhook_branch_env_link").on("change",function(t){var i=e(t.currentTarget),n=i.data("project-id"),a=i.data("type"),s="/webhook/"+n+"/branch-env-link";"build"==a&&(s+="/build"),i.attr("disabled","disabled"),e.ajax({type:"POST",url:s,dataType:"json",data:{value:e(this).prop("checked")?1:0}}).fail(function(e){}).done(function(e){}).always(function(){i.removeAttr("disabled")})})}(jQuery),function(e){e("#pattern").on("show.bs.modal",function(t){var i=e(t.relatedTarget),n=e(this),a=trans("patterns.create");e(".btn-danger",n).hide(),e(".callout-danger",n).hide(),e(".has-error",n).removeClass("has-error"),e(".label-danger",n).remove(),i.hasClass("btn-edit")?(a=trans("patterns.edit"),e(".btn-danger",n).show()):(e("#pattern_id").val(""),e("#name").val(""),e("#copy_pattern").val("")),n.find(".modal-title span").text(a)}),e("body").delegate(".pattern-trash button.btn-delete","click",function(t){var i=e(t.currentTarget),n=i.find("i"),a=i.parents(".modal");n.removeClass().addClass("piplin piplin-load piplin-spin"),a.find("input").attr("disabled","disabled"),e("button.close",a).hide(),
Piplin.Patterns.get(e("#model_id").val()).destroy({wait:!0,success:function(t,i,s){a.modal("hide"),e(".callout-danger",a).hide(),n.removeClass().addClass("piplin piplin-delete"),e("button.close",a).show(),a.find("input").removeAttr("disabled"),Piplin.toast(trans("patterns.delete_success"))},error:function(){n.removeClass().addClass("piplin piplin-delete"),e("button.close",a).show(),a.find("input").removeAttr("disabled")}})}),e("#pattern button.btn-save").on("click",function(t){var i=e(t.currentTarget),n=i.find("i"),a=i.parents(".modal");n.removeClass().addClass("piplin piplin-load piplin-spin"),a.find("input").attr("disabled","disabled"),e("button.close",a).hide();var s=e("#pattern_id").val();if(s)var l=Piplin.Patterns.get(s);else var l=new Piplin.Pattern;l.save({name:e("#name").val(),copy_pattern:e("#copy_pattern").val(),build_plan_id:e('input[name="build_plan_id"]').val()},{wait:!0,success:function(t,i,l){a.modal("hide"),e(".callout-danger",a).hide(),n.removeClass().addClass("piplin piplin-save"),e("button.close",a).show(),a.find("input").removeAttr("disabled");var o=trans("patterns.edit_success");s||(Piplin.Patterns.add(i),trans("patterns.create_success")),Piplin.toast(o)},error:function(t,i,s){e(".callout-danger",a).show();var l=i.responseJSON;e(".has-error",a).removeClass("has-error"),e(".label-danger",a).remove(),e("form input",a).each(function(t,i){i=e(i);var n=i.attr("name");if(void 0!==l[n]){var a=i.parent("div");a.addClass("has-error"),a.append(e("<span>").attr("class","label label-danger").text(l[n]))}}),n.removeClass().addClass("piplin piplin-save"),e("button.close",a).show(),a.find("input").removeAttr("disabled")}})}),Piplin.Pattern=Backbone.Model.extend({urlRoot:"/patterns"});var t=Backbone.Collection.extend({model:Piplin.Pattern});Piplin.Patterns=new t,Piplin.PatternsTab=Backbone.View.extend({el:"#app",events:{},initialize:function(){this.$list=e("#pattern_list tbody"),e("#no_patterns").show(),e("#pattern_list").hide(),this.listenTo(Piplin.Patterns,"add",this.addOne),this.listenTo(Piplin.Patterns,"reset",this.addAll),this.listenTo(Piplin.Patterns,"remove",this.addAll),this.listenTo(Piplin.Patterns,"all",this.render),Piplin.listener.on("pattern:"+Piplin.events.MODEL_CHANGED,function(e){var t=Piplin.Patterns.get(parseInt(e.model.id));t&&t.set(e.model)}),Piplin.listener.on("pattern:"+Piplin.events.MODEL_CREATED,function(t){var i=e('input[name="build_plan_id"]').val();parseInt(t.model.build_plan_id)===parseInt(i)&&Piplin.Patterns.add(t.model)}),Piplin.listener.on("pattern:"+Piplin.events.MODEL_TRASHED,function(e){var t=Piplin.Patterns.get(parseInt(e.model.id));t&&Piplin.Patterns.remove(t)})},render:function(){Piplin.Patterns.length?(e("#no_patterns").hide(),e("#pattern_list").show()):(e("#no_patterns").show(),e("#pattern_list").hide())},addOne:function(e){var t=new Piplin.PatternView({model:e});this.$list.append(t.render().el)},addAll:function(){this.$list.html(""),Piplin.Patterns.each(this.addOne,this)}}),Piplin.PatternView=Backbone.View.extend({tagName:"tr",events:{"click .btn-edit":"edit","click .btn-delete":"trash"},initialize:function(){this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"destroy",this.remove),this.template=_.template(e("#pattern-template").html())},render:function(){var e=this.model.toJSON();return this.$el.html(this.template(e)),this},edit:function(){e("#pattern_id").val(this.model.id),e("#name").val(this.model.get("name")),e("#copy_pattern").val(this.model.get("copy_pattern"))},trash:function(){var t=e("#model_id");t.val(this.model.id),t.parents(".modal").removeClass().addClass("modal fade pattern-trash")}})}(jQuery),function(e){if(0!==e("#upload").length){e("#skin").on("change",function(){e("body").removeClass(),e("body").addClass("skin-"+e(this).find(":selected").val())}),e("#two-factor-auth").on("change",function(){var t=e(".auth-code");e(this).is(":checked")?t.removeClass("hide"):t.addClass("hide")}),e("#request-change-email").on("click",function(){var t=e(this).parents(".box");t.children(".overlay").removeClass("hide"),e.post("/profile/email",function(e){"success"==e&&(t.children(".overlay").addClass("hide"),t.find(".help-block").removeClass("hide"))})});var t={};e(".avatar>img").cropper({aspectRatio:1,preview:".avatar-preview",crop:function(e){t.dataX=Math.round(e.x),t.dataY=Math.round(e.y),t.dataHeight=Math.round(e.height),t.dataWidth=Math.round(e.width),t.dataRotate=Math.round(e.rotate)},built:function(){e("#upload-overlay").addClass("hide")}});new Uploader({trigger:"#upload",name:"file",action:"/profile/upload",accept:"image/*",data:{_token:e('meta[name="token"]').attr("content")},multiple:!1,change:function(){e("#upload-overlay").removeClass("hide"),this.submit()},error:function(t){t.responseJSON.file?alert(t.responseJSON.file.join("")):t.responseJSON.error&&alert(t.responseJSON.error.message),e("#upload-overlay").addClass("hide")},success:function(i){"success"===i.message&&(e(".avatar>img").cropper("replace",i.image),t.path=i.path,e(".current-avatar-preview").addClass("hide"),e(".avatar-preview").removeClass("hide"),e("#save-avatar").removeClass("hide"))}});e("#save-avatar").on("click",function(){e("#upload-overlay").removeClass("hide"),e(".avatar-message .alert").addClass("hide"),e.post("/profile/avatar",t).success(function(t){e("#upload-overlay").addClass("hide"),t.image?(e(".avatar-message .alert.alert-success").removeClass("hide"),e("#use-gravatar").removeClass("hide")):e(".avatar-message .alert.alert-danger").removeClass("hide")})}),e("#use-gravatar").on("click",function(){e("#upload-overlay").removeClass("hide"),e(".avatar-message .alert").addClass("hide"),e.post("/profile/gravatar").success(function(t){e("#upload-overlay").addClass("hide"),e(".avatar-message .alert.alert-success").removeClass("hide"),e(".avatar-preview").addClass("hide"),e(".current-avatar-preview").removeClass("hide"),e(".current-avatar-preview").attr("src",t.image),e("#use-gravatar").addClass("hide"),e("#avatar-save-buttons button").addClass("hide")})})}}(jQuery),function(e){e("#link").on("show.bs.modal",function(t){var i=e(t.relatedTarget),n=e(this),a=trans("links.create");e(".btn-danger",n).hide(),e(".callout-danger",n).hide(),e(".has-error",n).removeClass("has-error"),e(".label-danger",n).remove(),i.hasClass("btn-edit")?(a=trans("links.edit"),e(".btn-danger",n).show(),e(".link-environment").prop("checked",!1),Piplin.EnvironmentLinks.each(function(t){e("#link_opposite_environment_"+t.id).prop("checked",!0)})):e(".link-environment").prop("checked",!0),n.find(".modal-title span").text(a)}),e("#link button.btn-save").on("click",function(t){var i=e(t.currentTarget),n=i.find("i"),a=i.parents(".modal");n.removeClass().addClass("piplin piplin-load piplin-spin"),a.find("input").attr("disabled","disabled"),e("button.close",a).hide();var s=new Piplin.EnvironmentLink,l=[];e(".link-environment:checked").each(function(){l.push(e(this).val())});e(".opposite-environments").fadeOut(3e3),s.save({environment_id:e('input[name="environment_id"]').val(),link_type:e("#link_type").val(),environments:l},{wait:!0,success:function(t,i,s){a.modal("hide"),e(".callout-danger",a).hide(),n.removeClass().addClass("piplin piplin-delete"),e("button.close",a).show(),a.find("input").removeAttr("disabled"),Piplin.EnvironmentLinks.reset(i),Piplin.toast(trans("environments.link_success"))},error:function(t,i,s){n.removeClass().addClass("piplin piplin-delete"),e("button.close",a).show(),a.find("input").removeAttr("disabled")}})}),Piplin.EnvironmentLink=Backbone.Model.extend({urlRoot:"/environment-links"});var t=Backbone.Collection.extend({model:Piplin.EnvironmentLink});Piplin.EnvironmentLinks=new t,Piplin.EnvironmentLinksTab=Backbone.View.extend({el:"#app",events:{},initialize:function(){this.$list=e("#link_list tbody"),e("#no_links").show(),e("#link_list").hide(),this.listenTo(Piplin.EnvironmentLinks,"add",this.addOne),this.listenTo(Piplin.EnvironmentLinks,"reset",this.addAll),this.listenTo(Piplin.EnvironmentLinks,"remove",this.addAll),this.listenTo(Piplin.EnvironmentLinks,"all",this.render)},render:function(){Piplin.EnvironmentLinks.length?(e("#no_links").hide(),e("#link_list").show()):(e("#no_links").show(),e("#link_list").hide())},addOne:function(e){var t=new Piplin.EnvironmentLinkView({model:e});this.$list.append(t.render().el)},addAll:function(){this.$list.html(""),Piplin.EnvironmentLinks.each(this.addOne,this)}}),Piplin.EnvironmentLinkView=Backbone.View.extend({tagName:"tr",initialize:function(){this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"destroy",this.remove),this.template=_.template(e("#link-template").html())},render:function(){var e=this.model.toJSON(),t=parseInt(e.pivot.link_type);return e.link_type=1==t?trans("environments.link_auto"):trans("environments.link_manual"),this.$el.html(this.template(e)),this}})}(jQuery),function(e){e("#release").on("show.bs.modal",function(t){var i=e(this);e(".callout-danger",i).hide()}),e("#release button.btn-save").on("click",function(t){var i=e(t.currentTarget),n=i.find("i"),a=i.parents(".modal");n.removeClass().addClass("piplin piplin-load piplin-spin"),a.find("input").attr("disabled","disabled"),e("button.close",a).hide();var s=new Piplin.Release,l=e('input[name="task_id"]').val();s.save({project_id:e('input[name="project_id"]').val(),task_id:l,name:e("#release_name").val()},{wait:!0,success:function(t,i,s){a.modal("hide"),e(".callout-danger",a).hide(),n.removeClass().addClass("piplin piplin-save"),e("button.close",a).show(),a.find("input").removeAttr("disabled");var o=trans("releases.create_success");Piplin.toast(o),window.location.href="/task/"+l},error:function(t,i,s){e(".callout-danger",a).show();var l=i.responseJSON;e(".has-error",a).removeClass("has-error"),e(".label-danger",a).remove(),e("form :input",a).each(function(t,i){i=e(i);var n=i.attr("name");if(void 0!==l[n]){var a=i.parent("div");a.addClass("has-error"),a.append(e("<span>").attr("class","label label-danger").text(l[n]))}}),n.removeClass().addClass("piplin piplin-save"),e("button.close",a).show(),a.find("input").removeAttr("disabled")}})}),e("body").delegate(".release-trash button.btn-delete","click",function(t){var i=e(t.currentTarget),n=i.find("i"),a=i.parents(".modal");n.removeClass().addClass("piplin piplin-load piplin-spin"),a.find("input").attr("disabled","disabled"),e("button.close",a).hide(),Piplin.Releases.get(e("#model_id").val()).destroy({wait:!0,success:function(t,i,s){a.modal("hide"),e(".callout-danger",a).hide(),n.removeClass().addClass("piplin piplin-delete"),e("button.close",a).show(),a.find("input").removeAttr("disabled"),Piplin.toast(trans("releases.delete_success"))},error:function(){n.removeClass().addClass("piplin piplin-delete"),e("button.close",a).show(),a.find("input").removeAttr("disabled")}})}),Piplin.Release=Backbone.Model.extend({urlRoot:"/releases"});var t=Backbone.Collection.extend({model:Piplin.Release});Piplin.Releases=new t,Piplin.ReleasesTab=Backbone.View.extend({el:"#app",events:{},initialize:function(){this.$list=e("#release_list tbody"),e("#no_releases").show(),e("#release_list").hide(),this.listenTo(Piplin.Releases,"add",this.addOne),this.listenTo(Piplin.Releases,"reset",this.addAll),this.listenTo(Piplin.Releases,"remove",this.addAll),this.listenTo(Piplin.Releases,"all",this.render),Piplin.listener.on("release:"+Piplin.events.MODEL_CHANGED,function(e){var t=Piplin.Releases.get(parseInt(e.model.id));t&&t.set(e.model)}),Piplin.listener.on("release:"+Piplin.events.MODEL_CREATED,function(t){var i=e('input[name="build_plan_id"]').val();parseInt(t.model.build_plan_id)===parseInt(i)&&Piplin.Releases.add(t.model)}),Piplin.listener.on("release:"+Piplin.events.MODEL_TRASHED,function(e){var t=Piplin.Releases.get(parseInt(e.model.id));t&&Piplin.Releases.remove(t)})},render:function(){Piplin.Releases.length?(e("#no_releases").hide(),e("#release_list").show()):(e("#no_releases").show(),e("#release_list").hide())},addOne:function(e){var t=new Piplin.ReleaseView({model:e});this.$list.append(t.render().el)},addAll:function(){this.$list.html(""),Piplin.Releases.each(this.addOne,this)}}),Piplin.ReleaseView=Backbone.View.extend({tagName:"tr",events:{"click .btn-edit":"edit","click .btn-delete":"trash"},initialize:function(){this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"destroy",this.remove),this.template=_.template(e("#release-template").html())},render:function(){var e=this.model.toJSON();return this.$el.html(this.template(e)),this},edit:function(){e("#release_id").val(this.model.id),e("#name").val(this.model.get("name")),e("#copy_release").val(this.model.get("copy_release"))},trash:function(){var t=e("#model_id");t.val(this.model.id),t.parents(".modal").removeClass().addClass("modal fade release-trash")}})}(jQuery),function(e){var t={placeholder:trans("cabinets.search"),minimumInputLength:1,width:"100%",ajax:{url:"/api/autocomplete/cabinets",dataType:"json",delay:250,data:function(e){return{q:e.term}},processResults:function(t){return{results:e.map(t,function(e){return{id:e.id,text:e.name}})}},cache:!0}},i=e(".environment-cabinets").select2(t);e("#cabinet").on("show.bs.modal",function(t){var n=e(t.relatedTarget),a=e(this),s=trans("cabinets.link");e(".btn-danger",a).hide(),e(".callout-danger",a).hide(),e(".callout-warning",a).hide(),e(".has-error",a).removeClass("has-error"),e(".label-danger",a).remove(),n.hasClass("btn-edit")?(s=trans("cabinets.edit"),e("#cabinet_ids").parent().parent().hide(),e(".btn-danger",a).show()):(e("#cabinet_ids").parent().parent().show(),i.val("").trigger("change"),a.find(".modal-title span").text(trans("cabinets.link"))),a.find(".modal-title span").text(s)}),e("#cabinet #cabinet-type a.btn-app").on("click",function(t){var i=e(t.currentTarget),n=e("#cabinet");if(i.attr("disabled"))return void e(".callout-warning",n).show();e(".callout-warning",n).hide()}),e("body").delegate(".cabinet-trash button.btn-delete","click",function(t){var i=e(t.currentTarget),n=i.find("i"),a=i.parents(".modal");n.removeClass().addClass("piplin piplin-load piplin-spin"),a.find("input").attr("disabled","disabled"),e("button.close",a).hide(),Piplin.Cabinets.get(e("#model_id").val()).destroy({wait:!0,success:function(t,i,s){a.modal("hide"),e(".callout-danger",a).hide(),n.removeClass().addClass("piplin piplin-save"),e("button.close",a).show(),a.find("input").removeAttr("disabled"),Piplin.toast(trans("cabinets.delete_success"))},error:function(){n.removeClass().addClass("piplin piplin-save"),e("button.close",a).show(),a.find("input").removeAttr("disabled")}})}),e("#cabinet button.btn-save").on("click",function(t){var i=e(t.currentTarget),n=i.find("i"),a=i.parents(".modal");n.removeClass().addClass("piplin piplin-load piplin-spin"),a.find("input").attr("disabled","disabled"),e("button.close",a).hide();var s=e("#cabinet_id").val();if(s)var l=Piplin.Cabinets.get(s);else var l=new Piplin.Cabinet;var o={cabinet_ids:e("#cabinet_ids").val(),environment_id:parseInt(e('input[name="environment_id"]').val())};l.save(o,{wait:!0,success:function(t,i,l){a.modal("hide"),e(".callout-danger",a).hide(),n.removeClass().addClass("piplin piplin-save"),e("button.close",a).show(),a.find("input").removeAttr("disabled");var o=trans("cabinets.edit_success");s||(Piplin.Cabinets.add(i),o=trans("cabinets.create_success")),Piplin.toast(o)},error:function(t,i,s){e(".callout-danger",a).show();var l=i.responseJSON;e(".has-error",a).removeClass("has-error"),e(".label-danger",a).remove(),e("form select",a).each(function(t,i){i=e(i);var n=i.attr("name");if(void 0!==l[n]){var a=i.parent();a.addClass("has-error"),a.append(e("<span>").attr("class","label label-danger").text(l[n]))}}),n.removeClass().addClass("piplin piplin-save"),e("button.close",a).show(),a.find("input").removeAttr("disabled")}})}),Piplin.Cabinet=Backbone.Model.extend({urlRoot:"/cabinets/"+parseInt(e('input[name="environment_id"]').val())});var n=Backbone.Collection.extend({model:Piplin.Cabinet});Piplin.Cabinets=new n,Piplin.CabinetsTab=Backbone.View.extend({el:"#app",events:{},initialize:function(){this.$list=e("#cabinet_list tbody"),e("#no_cabinets").show(),e("#cabinet_list").hide(),this.listenTo(Piplin.Cabinets,"add",this.addOne),this.listenTo(Piplin.Cabinets,"reset",this.addAll),this.listenTo(Piplin.Cabinets,"remove",this.addAll),this.listenTo(Piplin.Cabinets,"all",this.render),Piplin.listener.on("cabinet:"+Piplin.events.MODEL_CHANGED,function(e){var t=Piplin.Cabinets.get(parseInt(e.model.id));t&&t.set(e.model)}),Piplin.listener.on("cabinet:"+Piplin.events.MODEL_TRASHED,function(e){var t=Piplin.Cabinets.get(parseInt(e.model.id));t&&Piplin.Cabinets.remove(t)})},render:function(){Piplin.Cabinets.length?(e("#no_cabinets").hide(),e("#cabinet_list").show()):(e("#no_cabinets").show(),e("#cabinet_list").hide())},addOne:function(t){var i=new Piplin.CabinetView({model:t});this.$list.append(i.render().el),e(".server-names",this.$list).tooltip()},addAll:function(){this.$list.html(""),Piplin.Cabinets.each(this.addOne,this)}}),Piplin.CabinetView=Backbone.View.extend({tagName:"tr",events:{"click .btn-delete":"trash"},initialize:function(){this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"destroy",this.remove),this.template=_.template(e("#cabinet-template").html())},render:function(){var e=this.model.toJSON();return this.$el.html(this.template(e)),this},trash:function(){var t=e("#model_id");t.val(this.model.id),t.parents(".modal").removeClass().addClass("modal fade cabinet-trash")}})}(jQuery),function(e){e(".command-list table").sortable({containerSelector:"table",itemPath:"> tbody",itemSelector:"tr",placeholder:'<tr class="placeholder"/>',delay:500,onDrop:function(t,i,n){n(t,i);var a=[];e("tbody tr td:first-child",i.el[0]).each(function(t,i){a.push(e(i).data("command-id"))}),e.ajax({url:"/commands/reorder",method:"POST",data:{commands:a}})}});var t;e("#command").on("hidden.bs.modal",function(e){t.destroy()}),e("#command").on("show.bs.modal",function(i){var n=e(i.relatedTarget),a=e(this),s=trans("commands.create");t=ace.edit("command_script"),t.getSession().setMode("ace/mode/sh"),e(".btn-danger",a).hide(),e(".callout-danger",a).hide(),e(".has-error",a).removeClass("has-error"),e(".label-danger",a).remove(),n.hasClass("btn-edit")?(s=trans("commands.edit"),e(".btn-danger",a).show()):(e("#command_id").val(""),e("#command_step").val(n.data("step")),e("#command_name").val(""),t.setValue(""),t.gotoLine(1),e("#command_user").val(""),e("#command_optional").prop("checked",!1),e("#command_default_on").prop("checked",!1),e("#command_default_on_row").addClass("hide"),e(".command-environment").prop("checked",!0),e(".command-pattern").prop("checked",!0)),a.find(".modal-title span").text(s)}),e("body").delegate(".command-trash button.btn-delete","click",function(t){var i=e(t.currentTarget),n=i.find("i"),a=i.parents(".modal");n.removeClass().addClass("piplin piplin-load piplin-spin"),a.find("input").attr("disabled","disabled"),e("button.close",a).hide(),Piplin.Commands.get(e("#model_id").val()).destroy({wait:!0,success:function(t,i,s){a.modal("hide"),e(".callout-danger",a).hide(),n.removeClass().addClass("piplin piplin-delete"),e("button.close",a).show(),a.find("input").removeAttr("disabled"),Piplin.toast(trans("commands.delete_success"))},error:function(){n.removeClass().addClass("piplin piplin-delete"),e("button.close",a).show(),a.find("input").removeAttr("disabled")}})}),e("#command_optional").on("change",function(t){e("#command_default_on_row").addClass("hide"),!0===e(this).is(":checked")&&e("#command_default_on_row").removeClass("hide")}),e("#command button.btn-save").off("click").on("click",function(i){var n=e(i.currentTarget),a=n.find("i"),s=n.parents(".modal");a.removeClass().addClass("piplin piplin-load piplin-spin"),s.find(":input").attr("disabled","disabled"),e("button.close",s).hide();var l=e("#command_id").val();if(l)var o=Piplin.Commands.get(l);else var o=new Piplin.Command;var r=[];e(".command-environment:checked").each(function(){r.push(e(this).val())});var d=[];e(".command-pattern:checked").each(function(){d.push(e(this).val())}),o.save({name:e("#command_name").val(),script:t.getValue(),user:e("#command_user").val(),step:e("#command_step").val(),targetable_type:e('input[name="targetable_type"]').val(),targetable_id:e('input[name="targetable_id"]').val(),environments:r,patterns:d,optional:e("#command_optional").is(":checked"),default_on:e("#command_default_on").is(":checked")},{wait:!0,success:function(i,n,o){s.modal("hide"),e(".callout-danger",s).hide(),a.removeClass().addClass("piplin piplin-save"),e("button.close",s).show(),s.find(":input").removeAttr("disabled");var r=trans("commands.edit_success");l||(Piplin.Commands.add(n),r=trans("commands.create_success")),t.setValue(""),t.gotoLine(1),Piplin.toast(r)},error:function(t,i,n){e(".callout-danger",s).show();var l=i.responseJSON;e(".has-error",s).removeClass("has-error"),e(".label-danger",s).remove(),e("form input",s).each(function(t,i){i=e(i);var n=i.attr("name");if(void 0!==l[n]){var a=i.parent("div");a.addClass("has-error"),a.append(e("<span>").attr("class","label label-danger").text(l[n]))}}),a.removeClass().addClass("piplin piplin-save"),e("button.close",s).show(),s.find(":input").removeAttr("disabled")}})}),Piplin.Command=Backbone.Model.extend({urlRoot:"/commands",defaults:function(){return{order:Piplin.Commands.nextOrder()}},isAfter:function(){return parseInt(this.get("step"))%3==0}});var i=Backbone.Collection.extend({model:Piplin.Command,comparator:"order",nextOrder:function(){return this.length?this.last().get("order")+1:1}});Piplin.Commands=new i,Piplin.CommandsTab=Backbone.View.extend({el:"#app",events:{},initialize:function(){this.$beforeList=e("#commands-before .command-list tbody"),this.$afterList=e("#commands-after .command-list tbody"),e(".no-commands").show(),e(".command-list").hide(),this.listenTo(Piplin.Commands,"add",this.addOne),this.listenTo(Piplin.Commands,"reset",this.addAll),this.listenTo(Piplin.Commands,"remove",this.addAll),this.listenTo(Piplin.Commands,"all",this.render),Piplin.listener.on("command:"+Piplin.events.MODEL_CHANGED,function(e){var t=Piplin.Commands.get(parseInt(e.model.id));t&&t.set(e.model)}),Piplin.listener.on("command:"+Piplin.events.MODEL_CREATED,function(t){var i=e('input[name="targetable_type"]').val(),n=e('input[name="targetable_id"]').val();i==t.model.targetable_type&&parseInt(t.model.targetable_id)===parseInt(n)&&(parseInt(t.model.step)+1!==parseInt(Piplin.command_action)&&parseInt(t.model.step)-1!==parseInt(Piplin.command_action)||Piplin.Commands.add(t.model))}),Piplin.listener.on("command:"+Piplin.events.MODEL_TRASHED,function(e){var t=Piplin.Commands.get(parseInt(e.model.id));t&&Piplin.Commands.remove(t)})},render:function(){void 0!==Piplin.Commands.find(function(e){return!e.isAfter()})?(e("#commands-before .no-commands").hide(),e("#commands-before .command-list").show()):(e("#commands-before .no-commands").show(),e("#commands-before .command-list").hide()),void 0!==Piplin.Commands.find(function(e){return e.isAfter()})?(e("#commands-after .no-commands").hide(),e("#commands-after .command-list").show()):(e("#commands-after .no-commands").show(),e("#commands-after .command-list").hide())},addOne:function(t){var i=new Piplin.CommandView({model:t});t.isAfter()?(this.$afterList.append(i.render().el),e("tr",this.$afterList).length<2?e(".drag-handle",this.$afterList).hide():e(".drag-handle",this.$afterList).show()):(this.$beforeList.append(i.render().el),e("tr",this.$beforeList).length<2?e(".drag-handle",this.$beforeList).hide():e(".drag-handle",this.$beforeList).show())},addAll:function(){this.$beforeList.html(""),this.$afterList.html(""),Piplin.Commands.each(this.addOne,this)}}),Piplin.CommandView=Backbone.View.extend({tagName:"tr",events:{"click .btn-edit":"edit","click .btn-delete":"trash"},initialize:function(){this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"destroy",this.remove),this.template=_.template(e("#command-template").html())},render:function(){var e=this.model.toJSON();return this.$el.html(this.template(e)),this},edit:function(){e("#command_id").val(this.model.id),e("#command_step").val(this.model.get("step")),e("#command_name").val(this.model.get("name")),e("#command_script").text(this.model.get("script")),e("#command_user").val(this.model.get("user")),e("#command_optional").prop("checked",!0===this.model.get("optional")),e("#command_default_on").prop("checked",!0===this.model.get("default_on")),e("#command_default_on_row").addClass("hide"),!0===this.model.get("optional")&&e("#command_default_on_row").removeClass("hide"),e(".command-environment").prop("checked",!1),e(this.model.get("environments")).each(function(t,i){e("#command_environment_"+i.id).prop("checked",!0)}),e(".command-pattern").prop("checked",!1),e(this.model.get("patterns")).each(function(t,i){e("#command_pattern_"+i.id).prop("checked",!0)})},trash:function(){var t=e("#model_id");t.val(this.model.id),t.parents(".modal").removeClass().addClass("modal fade command-trash")}})}(jQuery),function(e){var t,i;e("#configfile, #view-configfile, #sync-configfile").on("hidden.bs.modal",function(e){t.destroy()}),e("#view-configfile").on("show.bs.modal",function(e){t=ace.edit("preview-content"),t.setReadOnly(!0),t.getSession().setUseWrapMode(!0);var n=i.substr(i.lastIndexOf(".")+1).toLowerCase();"php"===n||"ini"===n?t.getSession().setMode("ace/mode/"+n):"yml"===n&&t.getSession().setMode("ace/mode/yaml")}),e("#configfile").on("show.bs.modal",function(i){var n=e(i.relatedTarget),a=e(this),s=trans("configFiles.create");t=ace.edit("content");var l=e("#path").val(),o=l.substr(l.lastIndexOf(".")+1).toLowerCase();"php"===o||"ini"===o?t.getSession().setMode("ace/mode/"+o):"yml"===o&&t.getSession().setMode("ace/mode/yaml"),e(".btn-danger",a).hide(),e(".callout-danger",a).hide(),e(".has-error",a).removeClass("has-error"),e(".label-danger",a).remove(),n.hasClass("btn-edit")?(s=trans("configFiles.edit"),e(".btn-danger",a).show()):(e("#file_id").val(""),e("#name").val(""),e("#path").val(""),e(".configfile-environment").prop("checked",!0),t.setValue(""),t.gotoLine(1)),a.find(".modal-title span").text(s)}),e("body").delegate(".configfile-trash button.btn-delete","click",function(t){var i=e(t.currentTarget),n=i.find("i"),a=i.parents(".modal");n.removeClass().addClass("piplin piplin-load piplin-spin"),a.find("input").attr("disabled","disabled"),e("button.close",a).hide(),Piplin.ConfigFiles.get(e("#model_id").val()).destroy({wait:!0,success:function(t,i,s){a.modal("hide"),e(".callout-danger",a).hide(),n.removeClass().addClass("piplin piplin-delete"),e("button.close",a).show(),a.find("input").removeAttr("disabled"),Piplin.toast(trans("configFiles.delete_success"))},error:function(){n.removeClass().addClass("piplin piplin-delete"),e("button.close",a).show(),a.find("input").removeAttr("disabled")}})}),e("#configfile button.btn-save").on("click",function(i){var n=e(i.currentTarget),a=n.find("i"),s=n.parents(".modal");a.removeClass().addClass("piplin piplin-load piplin-spin"),s.find("input").attr("disabled","disabled"),e("button.close",s).hide();var l=e("#config_file_id").val();if(l)var o=Piplin.ConfigFiles.get(l);else var o=new Piplin.ConfigFile;var r=[];e(".configfile-environment:checked").each(function(){r.push(e(this).val())}),o.save({name:e("#name").val(),path:e("#path").val(),targetable_type:e('input[name="targetable_type"]').val(),targetable_id:e('input[name="targetable_id"]').val(),environments:r,content:t.getValue()},{wait:!0,success:function(i,n,o){s.modal("hide"),e(".callout-danger",s).hide(),a.removeClass().addClass("piplin piplin-save"),e("button.close",s).show(),s.find("input").removeAttr("disabled");var r=trans("configFiles.edit_success");l||(Piplin.ConfigFiles.add(n),trans("configFiles.create_success")),t.setValue(""),t.gotoLine(1),Piplin.toast(r)},error:function(t,i,n){e(".callout-danger",s).show();var l=i.responseJSON;e(".has-error",s).removeClass("has-error"),e(".label-danger",s).remove(),e("form input",s).each(function(t,i){i=e(i);var n=i.attr("name");if(void 0!==l[n]){var a=i.parent("div");a.addClass("has-error"),a.append(e("<span>").attr("class","label label-danger").text(l[n]))}}),a.removeClass().addClass("piplin piplin-save"),e("button.close",s).show(),s.find("input").removeAttr("disabled")}})}),e("#sync-configfile button.btn-save").on("click",function(i){var n=e(i.currentTarget),a=n.find("i"),s=n.parents(".modal");a.removeClass().addClass("piplin piplin-load piplin-spin"),s.find("input").attr("disabled","disabled"),e("button.close",s).hide();var l=e("#sync-configfile_id").val();if(l)var o=Piplin.ConfigFiles.get(l);else var o=new Piplin.ConfigFile;o.set({status:3});var r=[];e(".sync-environment:checked").each(function(){r.push(e(this).val())});var d=t.getValue();e.ajax({type:"POST",url:"/config-files/"+l+"/sync",data:{post_commands:d,environment_ids:r}}).done(function(t){s.modal("hide"),e(".callout-danger",s).hide(),a.removeClass().addClass("piplin piplin-save"),e("button.close",s).show();var i=trans("configFiles.sync_success");Piplin.toast(i)}),console.log(d)}),Piplin.ConfigFile=Backbone.Model.extend({urlRoot:"/config-files"});var n=Backbone.Collection.extend({model:Piplin.ConfigFile});Piplin.ConfigFiles=new n,Piplin.ConfigFilesTab=Backbone.View.extend({el:"#app",events:{},initialize:function(){this.$list=e("#configfile_list tbody"),e("#no_configfiles").show(),e("#configfile_list").hide(),this.listenTo(Piplin.ConfigFiles,"add",this.addOne),this.listenTo(Piplin.ConfigFiles,"reset",this.addAll),this.listenTo(Piplin.ConfigFiles,"remove",this.addAll),this.listenTo(Piplin.ConfigFiles,"all",this.render),Piplin.listener.on("configfile:"+Piplin.events.MODEL_CHANGED,function(e){var t=Piplin.ConfigFiles.get(parseInt(e.model.id));t&&t.set(e.model)}),Piplin.listener.on("configfile:"+Piplin.events.MODEL_CREATED,function(t){var i=e('input[name="targetable_type"]').val(),n=e('input[name="targetable_id"]').val();i==t.model.targetable_type&&parseInt(t.model.targetable_id)===parseInt(n)&&Piplin.ConfigFiles.add(t.model)}),Piplin.listener.on("configfile:"+Piplin.events.MODEL_TRASHED,function(e){var t=Piplin.ConfigFiles.get(parseInt(e.model.id));t&&Piplin.ConfigFiles.remove(t)})},render:function(){Piplin.ConfigFiles.length?(e("#no_configfiles").hide(),e("#configfile_list").show()):(e("#no_configfiles").show(),e("#configfile_list").hide())},addOne:function(e){var t=new Piplin.ConfigFileView({model:e});this.$list.append(t.render().el)},addAll:function(){this.$list.html(""),Piplin.ConfigFiles.each(this.addOne,this)}}),Piplin.ConfigFileView=Backbone.View.extend({tagName:"tr",events:{"click .btn-edit":"edit","click .btn-delete":"trash","click .btn-view":"view","click .btn-sync":"sync","click .btn-show":"showLog"},initialize:function(){this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"destroy",this.remove),this.template=_.template(e("#configfiles-template").html())},render:function(){var e=this.model.toJSON();return e.status_css="orange",e.icon_css="circle",e.status=trans("configFiles.unsynced"),0===parseInt(this.model.get("status"))?(e.status_css="success",e.status=trans("configFiles.successful")):3===parseInt(this.model.get("status"))?(e.status_css="purple",e.icon_css="load piplin-spin",e.status=trans("configFiles.syncing")):2===parseInt(this.model.get("status"))&&(e.status_css="danger",e.status=trans("configFiles.failed")),this.$el.html(this.template(e)),this},view:function(){i=this.model.get("path"),e("#preview-content").text(this.model.get("content"))},showLog:function(){var t=this.model.toJSON();e("#log pre").html(t.output)},sync:function(){e("#sync-configfile_id").val(this.model.id),t=ace.edit("command_script"),t.setValue(""),t.gotoLine(1),e(".sync-environment").prop("checked",!1).prop("disabled",!0).parent().attr("class","text-gray"),e(this.model.get("environments")).each(function(t,i){e("#sync_environment_"+i.id).prop("checked",!0).prop("disabled",!1).parent().removeClass("text-gray")})},edit:function(){e("#config_file_id").val(this.model.id),
e("#name").val(this.model.get("name")),e("#path").val(this.model.get("path")),e("#content").text(this.model.get("content")),e(".configfile-environment").prop("checked",!1),e(this.model.get("environments")).each(function(t,i){e("#configfile_environment_"+i.id).prop("checked",!0)})},trash:function(){var t=e("#model_id");t.val(this.model.id),t.parents(".modal").removeClass().addClass("modal fade configfile-trash")}})}(jQuery),function(e){e("#environment_list table").sortable({containerSelector:"table",itemPath:"> tbody",itemSelector:"tr",placeholder:'<tr class="placeholder"/>',delay:500,onDrop:function(t,i,n){n(t,i);var a=[];e("tbody tr td:first-child",i.el[0]).each(function(t,i){a.push(e(i).data("environment-id"))}),e.ajax({url:"/environments/reorder",method:"POST",data:{environments:a}})}}),e("#environment").on("show.bs.modal",function(t){var i=e(t.relatedTarget),n=e(this),a=trans("environments.create");e(".btn-danger",n).hide(),e(".callout-danger",n).hide(),e(".has-error",n).removeClass("has-error"),e(".label-danger",n).remove(),e("#add-environment-command",n).hide(),i.hasClass("btn-edit")?(a=trans("environments.edit"),e(".btn-danger",n).show()):(e("#environment_id").val(""),e("#environment_name").val(""),e("#environment_description").val(""),e("#environment_default_on").prop("checked",!0),e("#add-environment-command",n).show()),n.find(".modal-title span").text(a)}),e("body").delegate(".environment-trash button.btn-delete","click",function(t){var i=e(t.currentTarget),n=i.find("i"),a=i.parents(".modal");n.removeClass().addClass("piplin piplin-load piplin-spin"),a.find("input").attr("disabled","disabled"),e("button.close",a).hide(),Piplin.Environments.get(e("#model_id").val()).destroy({wait:!0,success:function(t,i,s){a.modal("hide"),e(".callout-danger",a).hide(),n.removeClass().addClass("piplin piplin-delete"),e("button.close",a).show(),a.find("input").removeAttr("disabled"),Piplin.toast(trans("environments.delete_success"))},error:function(){n.removeClass().addClass("piplin piplin-delete"),e("button.close",a).show(),a.find("input").removeAttr("disabled")}})}),e("#environment button.btn-save").on("click",function(t){var i=e(t.currentTarget),n=i.find("i"),a=i.parents(".modal");n.removeClass().addClass("piplin piplin-load piplin-spin"),a.find("input").attr("disabled","disabled"),e("button.close",a).hide();var s=e("#environment_id").val();if(s)var l=Piplin.Environments.get(s);else var l=new Piplin.Environment;l.save({name:e("#environment_name").val(),description:e("#environment_description").val(),default_on:e("#environment_default_on").is(":checked"),targetable_type:e('input[name="targetable_type"]').val(),targetable_id:e('input[name="targetable_id"]').val(),add_commands:e("#environment_commands").is(":checked")},{wait:!0,success:function(t,i,l){a.modal("hide"),e(".callout-danger",a).hide(),n.removeClass().addClass("piplin piplin-save"),e("button.close",a).show(),a.find("input").removeAttr("disabled");var o=trans("environments.edit_success");s||(Piplin.Environments.add(i),o=trans("environments.create_success")),Piplin.toast(o)},error:function(t,i,s){e(".callout-danger",a).show();var l=i.responseJSON;e(".has-error",a).removeClass("has-error"),e(".label-danger",a).remove(),e("form input",a).each(function(t,i){i=e(i);var n=i.attr("name");if(void 0!==l[n]){var a=i.parent("div");a.addClass("has-error"),a.append(e("<span>").attr("class","label label-danger").text(l[n]))}}),n.removeClass().addClass("piplin piplin-save"),e("button.close",a).show(),a.find("input").removeAttr("disabled")}})}),Piplin.Environment=Backbone.Model.extend({urlRoot:"/environments",initialize:function(){}});var t=Backbone.Collection.extend({model:Piplin.Environment});Piplin.Environments=new t,Piplin.EnvironmentsTab=Backbone.View.extend({el:"#app",events:{},initialize:function(){this.$list=e("#environment_list tbody"),e("#no_environments").show(),e("#environment_list").hide(),this.listenTo(Piplin.Environments,"add",this.addOne),this.listenTo(Piplin.Environments,"reset",this.addAll),this.listenTo(Piplin.Environments,"remove",this.addAll),this.listenTo(Piplin.Environments,"all",this.render),Piplin.listener.on("environment:"+Piplin.events.MODEL_CHANGED,function(t){e("#environment_"+t.model.id).html(t.model.name);var i=Piplin.Environments.get(parseInt(t.model.id));i&&i.set(t.model)}),Piplin.listener.on("environment:"+Piplin.events.MODEL_CREATED,function(t){var i=e('input[name="targetable_type"]').val(),n=e('input[name="targetable_id"]').val();i==t.model.targetable_type&&parseInt(t.model.targetable_id)===parseInt(n)&&Piplin.Environments.add(t.model)}),Piplin.listener.on("environment:"+Piplin.events.MODEL_TRASHED,function(e){var t=Piplin.Environments.get(parseInt(e.model.id));t&&Piplin.Environments.remove(t)})},render:function(){Piplin.Environments.length?(e("#no_environments").hide(),e("#environment_list").show()):(e("#no_environments").show(),e("#environment_list").hide())},addOne:function(t){var i=new Piplin.EnvironmentView({model:t});this.$list.append(i.render().el),e(".server-names",this.$list).tooltip(),Piplin.Environments.length<2?e(".drag-handle",this.$list).hide():e(".drag-handle",this.$list).show()},addAll:function(){this.$list.html(""),Piplin.Environments.each(this.addOne,this)}}),Piplin.EnvironmentView=Backbone.View.extend({tagName:"tr",events:{"click .btn-edit":"edit","click .btn-delete":"trash"},initialize:function(){this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"destroy",this.remove),this.template=_.template(e("#environment-template").html())},render:function(){var t=this.model.toJSON(),i=Piplin.formatProjectStatus(parseInt(this.model.get("status")));return t=e.extend(t,i),t.last_run=null!=t.last_run?moment(t.last_run).fromNow():trans("app.never"),this.$el.html(this.template(t)),this},edit:function(){e("#environment_id").val(this.model.id),e("#environment_name").val(this.model.get("name")),e("#environment_description").val(this.model.get("description")),e("#environment_default_on").prop("checked",!0===this.model.get("default_on"))},trash:function(){var t=e("#model_id");t.val(this.model.id),t.parents(".modal").removeClass().addClass("modal fade environment-trash")}})}(jQuery),function(e){e("#sharedfile").on("show.bs.modal",function(t){var i=e(t.relatedTarget),n=e(this),a=trans("sharedFiles.create");e(".btn-danger",n).hide(),e(".callout-danger",n).hide(),e(".has-error",n).removeClass("has-error"),e(".label-danger",n).remove(),i.hasClass("btn-edit")?(a=trans("sharedFiles.edit"),e(".btn-danger",n).show()):(e("#sharedfile_id").val(""),e("#name").val(""),e("#file").val("")),n.find(".modal-title span").text(a)}),e("body").delegate(".sharedfile-trash button.btn-delete","click",function(t){var i=e(t.currentTarget),n=i.find("i"),a=i.parents(".modal");n.removeClass().addClass("piplin piplin-load piplin-spin"),a.find("input").attr("disabled","disabled"),e("button.close",a).hide(),Piplin.SharedFiles.get(e("#model_id").val()).destroy({wait:!0,success:function(t,i,s){a.modal("hide"),e(".callout-danger",a).hide(),n.removeClass().addClass("piplin piplin-delete"),e("button.close",a).show(),a.find("input").removeAttr("disabled"),Piplin.toast(trans("sharedFiles.delete_success"))},error:function(){n.removeClass().addClass("piplin piplin-delete"),e("button.close",a).show(),a.find("input").removeAttr("disabled")}})}),e("#sharedfile button.btn-save").on("click",function(t){var i=e(t.currentTarget),n=i.find("i"),a=i.parents(".modal");n.removeClass().addClass("piplin piplin-load piplin-spin"),a.find("input").attr("disabled","disabled"),e("button.close",a).hide();var s=e("#sharedfile_id").val();if(s)var l=Piplin.SharedFiles.get(s);else var l=new Piplin.SharedFile;l.save({name:e("#name").val(),file:e("#file").val(),targetable_type:e('input[name="targetable_type"]').val(),targetable_id:e('input[name="targetable_id"]').val()},{wait:!0,success:function(t,i,l){a.modal("hide"),e(".callout-danger",a).hide(),n.removeClass().addClass("piplin piplin-save"),e("button.close",a).show(),a.find("input").removeAttr("disabled");var o=trans("sharedFiles.edit_success");s||(Piplin.SharedFiles.add(i),trans("sharedFiles.create_success")),Piplin.toast(o)},error:function(t,i,s){e(".callout-danger",a).show();var l=i.responseJSON;e(".has-error",a).removeClass("has-error"),e(".label-danger",a).remove(),e("form input",a).each(function(t,i){i=e(i);var n=i.attr("name");if(void 0!==l[n]){var a=i.parent("div");a.addClass("has-error"),a.append(e("<span>").attr("class","label label-danger").text(l[n]))}}),n.removeClass().addClass("piplin piplin-save"),e("button.close",a).show(),a.find("input").removeAttr("disabled")}})}),Piplin.SharedFile=Backbone.Model.extend({urlRoot:"/shared-files"});var t=Backbone.Collection.extend({model:Piplin.SharedFile});Piplin.SharedFiles=new t,Piplin.SharedFilesTab=Backbone.View.extend({el:"#app",events:{},initialize:function(){this.$list=e("#sharedfile_list tbody"),e("#no_sharedfiles").show(),e("#sharedfile_list").hide(),this.listenTo(Piplin.SharedFiles,"add",this.addOne),this.listenTo(Piplin.SharedFiles,"reset",this.addAll),this.listenTo(Piplin.SharedFiles,"remove",this.addAll),this.listenTo(Piplin.SharedFiles,"all",this.render),Piplin.listener.on("sharedfile:"+Piplin.events.MODEL_CHANGED,function(e){var t=Piplin.SharedFiles.get(parseInt(e.model.id));t&&t.set(e.model)}),Piplin.listener.on("sharedfile:"+Piplin.events.MODEL_CREATED,function(t){var i=e('input[name="targetable_type"]').val(),n=e('input[name="targetable_id"]').val();i==t.model.targetable_type&&parseInt(t.model.targetable_id)===parseInt(n)&&Piplin.SharedFiles.add(t.model)}),Piplin.listener.on("sharedfile:"+Piplin.events.MODEL_TRASHED,function(e){var t=Piplin.SharedFiles.get(parseInt(e.model.id));t&&Piplin.SharedFiles.remove(t)})},render:function(){Piplin.SharedFiles.length?(e("#no_sharedfiles").hide(),e("#sharedfile_list").show()):(e("#no_sharedfiles").show(),e("#sharedfile_list").hide())},addOne:function(e){var t=new Piplin.SharedFileView({model:e});this.$list.append(t.render().el)},addAll:function(){this.$list.html(""),Piplin.SharedFiles.each(this.addOne,this)}}),Piplin.SharedFileView=Backbone.View.extend({tagName:"tr",events:{"click .btn-edit":"edit","click .btn-delete":"trash"},initialize:function(){this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"destroy",this.remove),this.template=_.template(e("#sharedfile-template").html())},render:function(){var e=this.model.toJSON();return this.$el.html(this.template(e)),this},edit:function(){e("#sharedfile_id").val(this.model.id),e("#name").val(this.model.get("name")),e("#file").val(this.model.get("file"))},trash:function(){var t=e("#model_id");t.val(this.model.id),t.parents(".modal").removeClass().addClass("modal fade sharedfile-trash")}})}(jQuery),function(e){e("#variable").on("show.bs.modal",function(t){var i=e(t.relatedTarget),n=e(this),a=trans("variables.create");e(".btn-danger",n).hide(),e(".callout-danger",n).hide(),e(".has-error",n).removeClass("has-error"),e(".label-danger",n).remove(),i.hasClass("btn-edit")?(a=trans("variables.edit"),e(".btn-danger",n).show()):(e("#variable_id").val(""),e("#variable_name").val(""),e("#variable_value").val("")),n.find(".modal-title span").text(a)}),e("body").delegate(".variable-trash button.btn-delete","click",function(t){var i=e(t.currentTarget),n=i.find("i"),a=i.parents(".modal");n.removeClass().addClass("piplin piplin-load piplin-spin"),a.find("input").attr("disabled","disabled"),e("button.close",a).hide(),Piplin.Variables.get(e("#model_id").val()).destroy({wait:!0,success:function(t,i,s){a.modal("hide"),e(".callout-danger",a).hide(),n.removeClass().addClass("piplin piplin-delete"),e("button.close",a).show(),a.find("input").removeAttr("disabled"),Piplin.toast(trans("variables.delete_success"))},error:function(){n.removeClass().addClass("piplin piplin-delete"),e("button.close",a).show(),a.find("input").removeAttr("disabled")}})}),e("#variable button.btn-save").on("click",function(t){var i=e(t.currentTarget),n=i.find("i"),a=i.parents(".modal");n.removeClass().addClass("piplin piplin-load piplin-spin"),a.find("input").attr("disabled","disabled"),e("button.close",a).hide();var s=e("#variable_id").val();if(s)var l=Piplin.Variables.get(s);else var l=new Piplin.Variable;l.save({name:e("#variable_name").val(),value:e("#variable_value").val(),targetable_type:e('input[name="targetable_type"]').val(),targetable_id:e('input[name="targetable_id"]').val()},{wait:!0,success:function(t,i,l){a.modal("hide"),e(".callout-danger",a).hide(),n.removeClass().addClass("piplin piplin-save"),e("button.close",a).show(),a.find("input").removeAttr("disabled");var o=trans("variables.edit_success");s||(Piplin.Variables.add(i),o=trans("variables.create_success")),Piplin.toast(o)},error:function(t,i,s){e(".callout-danger",a).show();var l=i.responseJSON;e(".has-error",a).removeClass("has-error"),e(".label-danger",a).remove(),e("form input",a).each(function(t,i){i=e(i);var n=i.attr("name");if(void 0!==l[n]){var a=i.parent("div");a.addClass("has-error"),a.append(e("<span>").attr("class","label label-danger").text(l[n]))}}),n.removeClass().addClass("piplin piplin-save"),e("button.close",a).show(),a.find("input").removeAttr("disabled")}})}),Piplin.Variable=Backbone.Model.extend({urlRoot:"/variables",initialize:function(){}});var t=Backbone.Collection.extend({model:Piplin.Variable});Piplin.Variables=new t,Piplin.VariablesTab=Backbone.View.extend({el:"#app",events:{},initialize:function(){this.$list=e("#variable_list tbody"),e("#no_variables").show(),e("#variable_list").hide(),this.listenTo(Piplin.Variables,"add",this.addOne),this.listenTo(Piplin.Variables,"reset",this.addAll),this.listenTo(Piplin.Variables,"remove",this.addAll),this.listenTo(Piplin.Variables,"all",this.render),Piplin.listener.on("variable:"+Piplin.events.MODEL_CHANGED,function(t){e("#variable_"+t.model.id).html(t.model.name);var i=Piplin.Variables.get(parseInt(t.model.id));i&&i.set(t.model)}),Piplin.listener.on("variable:"+Piplin.events.MODEL_CREATED,function(t){var i=e('input[name="targetable_type"]').val(),n=e('input[name="targetable_id"]').val();i==t.model.targetable_type&&parseInt(t.model.targetable_id)===parseInt(n)&&Piplin.Variables.add(t.model)}),Piplin.listener.on("variable:"+Piplin.events.MODEL_TRASHED,function(e){var t=Piplin.Variables.get(parseInt(e.model.id));t&&Piplin.Variables.remove(t)})},render:function(){Piplin.Variables.length?(e("#no_variables").hide(),e("#variable_list").show()):(e("#no_variables").show(),e("#variable_list").hide())},addOne:function(e){var t=new Piplin.VariableView({model:e});this.$list.append(t.render().el)},addAll:function(){this.$list.html(""),Piplin.Variables.each(this.addOne,this)}}),Piplin.VariableView=Backbone.View.extend({tagName:"tr",events:{"click .btn-edit":"edit","click .btn-delete":"trash"},initialize:function(){this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"destroy",this.remove),this.template=_.template(e("#variable-template").html())},render:function(){var e=this.model.toJSON();return this.$el.html(this.template(e)),this},edit:function(){e("#variable_id").val(this.model.id),e("#variable_name").val(this.model.get("name")),e("#variable_value").val(this.model.get("value"))},trash:function(){var t=e("#model_id");t.val(this.model.id),t.parents(".modal").removeClass().addClass("modal fade variable-trash")}})}(jQuery),function(e){e("#server_list table").sortable({containerSelector:"table",itemPath:"> tbody",itemSelector:"tr",placeholder:'<tr class="placeholder"/>',delay:500,onDrop:function(t,i,n){n(t,i);var a=[];e("tbody tr td:first-child",i.el[0]).each(function(t,i){a.push(e(i).data("server-id"))}),e.ajax({url:"/servers/reorder",method:"POST",data:{servers:a}})}}),e("#server").on("show.bs.modal",function(t){var i=e(t.relatedTarget),n=e(this),a=trans("servers.create");e(".btn-danger",n).hide(),e(".callout-danger",n).hide(),e(".has-error",n).removeClass("has-error"),e(".label-danger",n).remove(),i.hasClass("btn-edit")?(a=trans("servers.edit"),e(".btn-danger",n).show()):(e("#server_id").val(""),e("#server_name").val(""),e("#server_enabled").prop("checked",!0),e("#server_address").val(""),e("#server_port").val("22"),e("#server_user").val(""),e("#server_targetable_id").val(e("#server_targetable_id option:selected").val())),n.find(".modal-title span").text(a)}),e("body").delegate(".server-trash button.btn-delete","click",function(t){var i=e(t.currentTarget),n=i.find("i"),a=i.parents(".modal");n.removeClass().addClass("piplin piplin-load piplin-spin"),a.find("input").attr("disabled","disabled"),e("button.close",a).hide(),Piplin.Servers.get(e("#model_id").val()).destroy({wait:!0,success:function(t,i,s){a.modal("hide"),e(".callout-danger",a).hide(),n.removeClass().addClass("piplin piplin-delete"),e("button.close",a).show(),a.find("input").removeAttr("disabled"),Piplin.toast(trans("servers.delete_success"))},error:function(){n.removeClass().addClass("piplin piplin-delete"),e("button.close",a).show(),a.find("input").removeAttr("disabled")}})}),e("#server button.btn-save").on("click",function(t){var i=e(t.currentTarget),n=i.find("i"),a=i.parents(".modal");n.removeClass().addClass("piplin piplin-load piplin-spin"),a.find("input").attr("disabled","disabled"),e("button.close",a).hide();var s=e("#server_id").val();if(s)var l=Piplin.Servers.get(s);else var l=new Piplin.Server;l.save({name:e("#server_name").val(),ip_address:e("#server_address").val(),enabled:e("#server_enabled").is(":checked"),port:e("#server_port").val(),user:e("#server_user").val(),targetable_type:e('input[name="targetable_type"]').val(),targetable_id:parseInt(e("#server_targetable_id").val())},{wait:!0,success:function(t,i,l){a.modal("hide"),e(".callout-danger",a).hide(),n.removeClass().addClass("piplin piplin-save"),e("button.close",a).show(),a.find("input").removeAttr("disabled");var o=trans("servers.edit_success");s||(Piplin.Servers.add(i),o=trans("servers.create_success")),Piplin.toast(o)},error:function(t,i,s){e(".callout-danger",a).show();var l=i.responseJSON;e(".has-error",a).removeClass("has-error"),e(".label-danger",a).remove(),e("form input",a).each(function(t,i){i=e(i);var n=i.attr("name");if(void 0!==l[n]){var a=i.parent("div");a.addClass("has-error"),a.append(e("<span>").attr("class","label label-danger").text(l[n]))}}),n.removeClass().addClass("piplin piplin-save"),e("button.close",a).show(),a.find("input").removeAttr("disabled")}})}),Piplin.Server=Backbone.Model.extend({urlRoot:"/servers"});var t=Backbone.Collection.extend({model:Piplin.Server,comparator:function(e,t){return e.get("name")>t.get("name")?-1:e.get("name")<t.get("name")?1:0}});Piplin.Servers=new t,Piplin.ServersTab=Backbone.View.extend({el:"#app",events:{},initialize:function(){this.$list=e("#server_list tbody"),e("#no_servers").show(),e("#server_list").hide(),this.listenTo(Piplin.Servers,"add",this.addOne),this.listenTo(Piplin.Servers,"reset",this.addAll),this.listenTo(Piplin.Servers,"remove",this.addAll),this.listenTo(Piplin.Servers,"all",this.render),Piplin.listener.on("server:"+Piplin.events.MODEL_CHANGED,function(e){var t=Piplin.Servers.get(parseInt(e.model.id));t&&(Piplin.targetable_id==e.model.targetable_id?t.set(e.model):Piplin.Servers.remove(t))}),Piplin.listener.on("server:"+Piplin.events.MODEL_CREATED,function(e){parseInt(e.model.targetable_id)===parseInt(Piplin.targetable_id)&&Piplin.Servers.add(e.model)}),Piplin.listener.on("server:"+Piplin.events.MODEL_TRASHED,function(e){var t=Piplin.Servers.get(parseInt(e.model.id));t&&Piplin.Servers.remove(t)})},render:function(){Piplin.Servers.length?(e("#no_servers").hide(),e("#server_list").show()):(e("#no_servers").show(),e("#server_list").hide())},addOne:function(t){var i=new Piplin.ServerView({model:t});this.$list.append(i.render().el),e(".server-names",this.$list).tooltip(),Piplin.Servers.length<2?e(".drag-handle",this.$list).hide():e(".drag-handle",this.$list).show()},addAll:function(){this.$list.html(""),Piplin.Servers.each(this.addOne,this)}}),Piplin.ServerView=Backbone.View.extend({tagName:"tr",events:{"click .btn-test":"testConnection","click .btn-show":"showLog","click .btn-edit":"edit","click .btn-delete":"trash"},initialize:function(){this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"destroy",this.remove),this.template=_.template(e("#server-template").html())},render:function(){var e=this.model.toJSON();return e.status_css="orange",e.icon_css="circle",e.status=trans("servers.untested"),0===parseInt(this.model.get("status"))?(e.status_css="success",e.status=trans("servers.successful")):3===parseInt(this.model.get("status"))?(e.status_css="purple",e.icon_css="load piplin-spin",e.status=trans("servers.testing")):2===parseInt(this.model.get("status"))&&(e.status_css="danger",e.status=trans("servers.failed")),this.$el.html(this.template(e)),this},edit:function(){e("#server_id").val(this.model.id),e("#server_name").val(this.model.get("name")),e("#server_targetable_id").select2(Piplin.select2_options).val(this.model.get("targetable_id")).trigger("change"),e("#server_enabled").prop("checked",!0===this.model.get("enabled")),e("#server_address").val(this.model.get("ip_address")),e("#server_port").val(this.model.get("port")),e("#server_user").val(this.model.get("user"))},showLog:function(){var t=this.model.toJSON();e("#log pre").html(t.output)},trash:function(){var t=e("#model_id");t.val(this.model.id),t.parents(".modal").removeClass().addClass("modal fade server-trash")},testConnection:function(){if(3!==parseInt(this.model.get("status"))){this.model.set({status:3});var t=this;e.ajax({type:"GET",url:this.model.urlRoot+"/"+this.model.id+"/test"}).fail(function(e){t.model.set({status:2})})}}})}(jQuery);